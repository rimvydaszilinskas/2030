<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>2030</title>
  <meta name="description" content="2030 Game site">
  <meta name="author" content="Rimvydas Zilinskas">
  <style>
    body{
      text-align: center;
    }

    #wheel{
      display: inline-block;
      position: relative;
      overflow: hidden;
    }

    #wheel:after{
      content: "";
      background: red;
      border: 2px solid white;
      position: absolute;
      top: -7px;
      left: 50%;
      width: 10px;
      height: 10px;
      margin-left: -7px;
      transform: rotate(45deg);
    }
  </style>
</head>

<body>

  <div id="wheel">
    <canvas id="canvas" width="400" height="400"></canvas>
  </div>
  <br>
    <button id="spin">Stop!</button>
  <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
  <script>
    function rand(min, max) {
      return Math.random() * (max - min) + min;
    }

    var color = ['red','green','blue','yellow','purple','black', "brown", "pink"];
    var label = ["Civil Society Representative", "Customer", "Environmentalist", "Economist", "Policymaker", "Stakeholder", "Shareholder", "Supply Chain Manager"];
    var slices = color.length;
    var sliceDeg = 360/slices;
    var deg = rand(0, 360);
    var speed = 0;
    var slowDownRand = 0;
    var ctx = canvas.getContext('2d');
    var width = canvas.width; // size
    var center = width/2;      // center
    var isStopped = false;
    var lock = false;

    function deg2rad(deg) {
      return deg * Math.PI/180;
    }

    function drawSlice(deg, color) {
      ctx.beginPath();
      ctx.fillStyle = color;
      ctx.moveTo(center, center);
      ctx.arc(center, center, width/2, deg2rad(deg), deg2rad(deg+sliceDeg));
      ctx.lineTo(center, center);
      ctx.fill();
    }

    function drawText(deg, text) {
      ctx.save();
      ctx.translate(center, center);
      ctx.rotate(deg2rad(deg));
      ctx.textAlign = "right";
      ctx.fillStyle = "#fff";
      ctx.font = 'bold 20px sans-serif';
      ctx.fillText(text, 180, 10);
      ctx.restore();
    }

    function drawImg() {
      ctx.clearRect(0, 0, width, width);
      for(var i=0; i<slices; i++){
        drawSlice(deg, color[i]);
        drawText(deg+sliceDeg/2, label[i]);
        deg += sliceDeg;
      }
      // ctx.beginPath();
      // ctx.arc(center, center, 50, 0, 2 * Math.PI, false);
      // ctx.fillStyle = "white";
      // ctx.fill();
      // ctx.save();
      // ctx.translate(center, center);
      // ctx.rotate(0);
      // ctx.textarea = "center";
      // ctx.fillStyle = "black";
      // ctx.font = "bold 10px sans-serif";
      // ctx.fillText("SPIN", -10, 0);
      // ctx.restore();
    }

    (function anim() {
      deg += speed;
      deg %= 360;

      // Increment speed
      if(!isStopped && speed<3){
        speed = speed+1 * 0.1;
      }
      // Decrement Speed
      if(isStopped){
        if(!lock){
          lock = true;
          slowDownRand = rand(0.994, 0.998);
        }
        speed = speed>0.2 ? speed*=slowDownRand : 0;
      }
      // Stopped!
      if(lock && !speed){
        var ai = Math.floor(((360 - deg - 90) % 360) / sliceDeg); // deg 2 Array Index
        ai = (slices+ai)%slices; // Fix negative index
        return alert("You got:\n"+ label[ai] ); // Get Array Item from end Degree
      }

      drawImg();
      window.requestAnimationFrame( anim );
    }());

    document.getElementById("spin").addEventListener("mousedown", function(){
      isStopped = true;
    }, false);

  </script>
</body>
</html>
